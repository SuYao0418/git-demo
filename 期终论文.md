![](./zjut1.png)

<center><b><big>游戏程序设计</big>

<center><b>期终论文</b></center>

<center><b>2022/2023(2)</b></center>

​                                                                                                     <img src="./zjut2.png" alt="img" style="zoom:30%;" /> 

<center><b><big>论文名称 对Marauroa的DB包下的设计模式的分析</big>

<center><b>学生姓名		       郭耀        </b></center>

<center><b>学生学号		      202003151002    </b></center>   

<center><b>学生班级		     移动应用开发2003    </b></center>  

<center><b>任课教师 陈波         </center></b></center>






<center><b>计算机科学与技术学院



------



[TOC]

## 一、介绍与背景知识

### 1.1Marauroa项目总体介绍

Marauroa是一个开源的多人在线游戏框架，旨在简化和加速多人在线游戏的开发过程。它提供了一个灵活的、可扩展的架构，以构建各种类型的多人在线游戏，包括角色扮演游戏（RPG）和战略游戏。

Marauroa的核心设计理念是基于服务器端的模型驱动架构。它采用Java语言编写，利用Java NIO（New IO）技术实现高效的网络通信。它提供了一组强大的服务器组件和工具，用于处理网络通信、数据持久化、游戏逻辑和玩家管理等关键任务。

### 1.2设计模式的基础介绍

设计模式是一套解决软件设计问题的经验总结和最佳实践的指导原则。它们是在实际软件开发中从重复出现的问题中抽象出来的可复用的解决方案。设计模式不是具体的算法或代码实现，而是关于如何组织和设计代码的思想和原则。

设计模式是软件开发中非常重要的一部分，它们提供了一种通用的思考和解决问题的方法，可以提高代码的质量和可维护性。理解和掌握设计模式可以使开发者更加灵活和高效地进行软件设计和开发。

------



## 二、DB包的模块介绍

DB包下面主要分为三大模块，下图为其包下的主要结构,下面分别对其进行介绍：

<img src="./图片1.png" style="zoom:80%;" />

<center>图1.DB包的内容结构图

###  2.1Adapter模块：

Adapter包是marauroa项目中db模块的子模块之一，它包含了与不同数据库类型交互的适配器类。这些适配器类实现了共同的接口，以提供统一的方法来执行数据库操作。

下图是Adapter包的主要类图：

<img src="./图片2.png" style="zoom:80%;" />

<center>图2.Adapter类图</center>

<center>表 1Adapter模块类介绍</center>

| 类名                       | 简单介绍                                                     |
| :------------------------- | ------------------------------------------------------------ |
| AbstractDatabaseAdapter    | 这个抽象类是所有数据库适配器的基类。它提供了一些通用的方法和属性，例如数据库连接管理、SQL语句执行和结果集处理。具体的数据库适配器类可以继承这个基类，并根据具体数据库的特性来实现自己的逻辑。 |
| CreateIndexStatementParser | 这个类用于解析创建索引的SQL语句。它可以解析SQL语句中的索引名称、表名称、列名称等信息，并将其转换为相应的数据结构。 |
| DatabaseAdapter            | 这个接口定义了数据库适配器的基本方法。它包含了执行查询和更新操作的方法，以及获取数据库连接和释放资源的方法。所有的数据库适配器类都必须实现这个接口，以保证一致的操作接口。 |
| H2DatabaseAdapter          | 这个类是针对H2数据库的适配器实现。它实现了DatabaseAdapter接口，并提供了与H2数据库交互的具体实现。 |
| MySQLDatabaseAdapter       | 这个类是针对MySQL数据库的适配器实现。它实现了DatabaseAdapter接口，并提供了与MySQL数据库交互的具体实现。 |
| PostgresDatabaseAdapter    | 这个类是针对PostgreSQL数据库的适配器实现。它实现了DatabaseAdapter接口，并提供了与PostgreSQL数据库交互的具体实现。 |

------



### 2.2Command模块：

<img src="./图片3.png" style="zoom:80%;" />

<Center>图3.Comman模块类图
<center>表 2Command模块类介绍


| 类名                           | 简单介绍                                                     |
| ------------------------------ | ------------------------------------------------------------ |
| DBCommandMetaData              | 这个类用于存储数据库命令的元数据信息，包括命令类型、命令描述、命令的执行优先级等。它提供了一种统一的方式来管理和传递数据库命令的元数据。 |
| DBCommandQueueBackgroundThread | 这个类是一个后台线程，用于从数据库命令队列中获取命令并执行。它通过循环不断地从命令队列中取出命令，并调用相应的执行方法来执行数据库操作。 |
| DBCommandQueue                 | 这个类是数据库命令队列，用于存储待执行的数据库命令。它提供了添加命令、获取命令和清空命令队列等操作方法，以及相应的线程同步机制，以确保多线程安全的访问。 |
| DBCommandPriority              | 这个枚举类定义了数据库命令的优先级，包括低、中和高三个级别。通过设置命令的优先级，可以在命令队列中对命令进行排序和执行优先级控制。 |
| DBCommandQueueLogger           | 这个类用于记录数据库命令队列的执行日志。它提供了日志记录的方法，可以记录命令的执行情况、执行时间等信息，以便后续的监控和分析。 |
| DBCommand                      | 这个抽象类是数据库命令的基类。它定义了数据库命令的执行接口和一些通用的属性和方法，例如命令的元数据、执行状态和结果等。具体的数据库命令类可以继承这个基类，并实现自己的数据库操作逻辑。 |
| AbstractDBCommand              | 这个抽象类是DBCommand的子类，它进一步封装了一些通用的数据库操作逻辑，例如获取数据库连接、执行SQL语句和处理结果集等。具体的数据库命令类可以继承这个抽象类，并根据具体的业务需求来实现自己的数据库操作逻辑。 |

------



### 2.3DB包下直接类：

<img src="./图片4.png" style="zoom:80%;" />

<center>图4.DB包下的直接类类图

<center>表3 DB表的模块类介绍

| 类名                        | 简单介绍                                                     |
| --------------------------- | ------------------------------------------------------------ |
| AdapterFactory              | 这个类是一个适配器工厂，用于创建特定数据库类型的适配器实例。根据数据库类型的不同，可以使用不同的适配器来处理数据库操作。 |
| DatabaseConnectionException | 这个类表示数据库连接异常，当数据库连接发生错误时，可以抛出该异常。 |
| DBTransaction               | 这个类用于管理数据库事务。它提供了开始、提交和回滚事务的方法，确保数据库操作的原子性和一致性。 |
| MaintenanceDBFactory        | 这个类是一个维护数据库工厂，用于创建执行数据库维护任务的实例。它可以创建不同类型的数据库维护器，如索引创建、表空间管理等。 |
| JDBCSQLHelper               | 这个类是一个辅助工具，用于执行数据库查询和更新操作。它封装了底层的JDBC调用，简化了数据库操作的编写和执行过程。 |
| StringChecker               | 这个类提供了一些静态方法，用于验证和检查字符串参数，以确保它们符合特定的格式和要求。 |
| TransactionPool             | 这个类是一个事务池，用于管理数据库连接的分配和回收。它提供了一种高效的方式来管理并发的数据库操作。 |
| UpdateScript                | 这个类用于执行数据库更新脚本。它可以解析和执行包含数据库更新语句的脚本文件，确保数据库的结构和数据与应用程序的要求保持一致。 |

----------------------------- ------------------------------------------------------------------------------------------------------------------------------

## 三、设计模式在db包中的应用

### 3.1Adapter包下的分析：

通过分析源码，总结出以下几点：

#### 1.模板方法模式（Template Method Pattern）：

抽象类AbstractDatabaseAdapter，它定义了数据库适配器的基本结构和算法，其中包含了具体的方法和抽象方法。这些方法的执行顺序和基本实现已经在抽象类中定义好，但其中某些步骤的具体实现由具体的子类来完成，通过模板方法模式将算法的具体实现延迟到子类中。例如H2DatabaseAdapter、MySQLDatabaseAdapter和PostgresDatabaseAdapter根据特定数据库的要求重写了抽象类的rewriteSql方法，以实现特定的SQL语句重写逻辑。

<img src="./图片5.png" style="zoom:50%;" />

<center>图5.原函数定义

<img src="./图片6.png" style="zoom:50%;" />

<center>图6.实现细节

这里用到的模板方法模式提供了一个通用的算法框架，而将一些具体实现细节延迟到子类中，使得子类可以根据特定需求进行具体实现，提高了代码的复用性和可扩展性。

#### 2.适配器模式（Adapter）

DatabaseAdapter接口定义了数据库适配器的通用方法，这些方法被具体的数据库适配器类实现。通过定义这个接口，适配器模式允许不同类型的数据库适配器在使用上具有一致的接口，从而使客户端代码可以与不同的适配器进行交互，而不需要了解其具体实现。

这些适配器类实现了DatabaseAdapter接口，并继承了AbstractDatabaseAdapter抽象类。通过这种方式，它们既提供了一致的接口，又可以重用AbstractDatabaseAdapter类中已经实现的通用逻辑。

在适配器类中，它们实现了在DatabaseAdapter接口中定义的方法，以提供对特定数据库的适配功能。这些方法可能涉及与具体数据库的连接、执行SQL查询和操作数据库等。

适配器类还重写了AbstractDatabaseAdapter类中的一些抽象方法，以提供特定数据库的实现细节。例如，在createConnection方法中，适配器类可以使用特定数据库的驱动程序来建立数据库连接。在rewriteSql方法中，适配器类可以对SQL语句进行特定数据库的语法转换或优化。

通过继承AbstractDatabaseAdapter类，适配器类可以重用其已经实现的通用逻辑，同时根据特定数据库的要求进行适当的调整和扩展。这种设计允许应用程序在面对不同类型的数据库时使用相同的接口进行操作，而无需直接处理数据库的细节。

综上所述，这些适配器类通过实现通用接口、继承抽象类和重写方法来提供特定数据库的适配功能。它们在使用上具有一致的接口，使得应用程序可以与不同类型的数据库进行交互，而不需要关心底层数据库的具体实现细节。

### 3.2Command包下的分析：

#### 1.命令模式(Command Pattern)：

DBCommand 类定义了一个命令接口 execute()，要求具体的命令类实现该接口。

DBCommand 是一个抽象类，提供了一些通用的方法和属性，可以被具体的命令类继承和实现。

具体的数据库命令类可以继承 DBCommand 并实现 execute() 方法来执行特定的数据库操作。

例如：

<img src="./图片7.png" style="zoom:50%;" />

<center>图7.很多继承方法

使用命令模式，我们可以将具体的数据库命令封装成对象，并将其作为参数传递给调用者，从而实现了命令的延迟执行、排队和处理。命令模式还使得我们可以更轻松地扩展和添加新的命令，而无需修改调用者的代码。

### 3.3DB包下的类的分析：

#### 1.工厂模式

AdapterFactory 类中，create 方法是工厂方法，用于创建 DatabaseAdapter 对象。它根据配置文件中的 database\_adapter 属性决定使用哪个具体的适配器类进行创建。如果配置文件中未指定适配器类，则默认使用 MySQLDatabaseAdapter 类。该方法返回一个 DatabaseAdapter 对象。

internalCreate 方法是工厂方法的实现。它根据配置文件中的 database\_adapter 属性使用反射机制动态创建适配器对象。它首先根据类名加载适配器类，然后获取构造函数，并使用提供的属性对象进行实例化。

<img src="./图片8.png" style="zoom:50%;" />

<center>图8.工厂模式实现源代码

通过使用工厂模式，AdapterFactory 类提供了一种灵活的方式来创建适配器对象。它根据配置文件中的属性决定适配器的类型，而不是直接依赖于特定的适配器类。这样可以轻松地扩展系统，以支持不同类型的数据库适配器。同时这里还提供了一种异常处理机制，使得在创建适配器对象时发生错误时可以进行重试，并提供适当的日志记录。

#### 2.代理模式

DBTransaction 类充当了数据库操作的代理类，它通过调用底层的 DatabaseAdapter 来执行具体的数据库操作。DBTransaction 类隐藏了 DatabaseAdapter 的复杂性，并提供了简化的接口供其他类使用。

例如：

<img src="./图片9.png" style="zoom:60%;" />

<center>图9.代理模式源代码

通过代理模式的使用，提供了对数据库操作的封装、管理和控制，隐藏了底层数据库适配器的细节，简化了数据库操作的使用和管理，并增加了一些额外的功能，以满足系统对数据库操作的需求。

------



## 四、结果与讨论

通过分析，marauroa中的设计模式的使用很多，并且都很具有代表性，例如对不同的数据库使用不同的数据库适配器，用工厂方法来构建、对复杂的算法实现通过模板方法模式去继承实现、对于不需要对外开放的接口及功能，通过代理模式进行进行封装和简化，此外还有很多用到的模式，例如观察者模、策略模式、建造者模式等还没做具体的分析，只对其中一些典型进行了分析。

这次分析对于设计模式的使用及其方便性、可维护性、可重用性有了更进一步的了解，对于平时自己写代码，也要多思考使用，方便以后修改重用，而不是把所有逻辑堆到一起去实现功能就好。

总的来说，marauroa这个游戏框架在服务器数据库的处理上把各个功能分割的很完美，设计模式的应用对我收获很大，对我之后的项目代码开发有很大的帮助与启示。
